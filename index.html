<!DOCTYPE html>
<html lang="en" ng-app="Primes">

<head>
  <title>Primes</title>
  <script src="bower_components/jquery/dist/jquery.min.js"></script>
  <script src="bower_components/angular/angular.js"></script>
  <script src="bower_components/ngInfiniteScroll/build/ng-infinite-scroll.min.js"></script>
  <style>
    table {
      table-layout: fixed;
      border-collapse: collapse;
    }
    tbody {
      table-layout: fixed;
    }
    td {
      width: 100px;
      height: 20px;
    }
  </style>
</head>

<body>
  <h1>Primes</h1>

  <div ng-controller="primesController" ng-cloak>
    <p>AngularJs application found first {{ primes.length }} prime numbers.</p>
    <table id="table" width="500">
      <tbody infinite-scroll="find()"
        infinite-scroll-distance="3"
        infinite-scroll-immediate-check="true"
        infinite-scroll-disabled="computing">
        <tr ng-repeat="prime in primes">
          <td>index</td>
          <td>{{ $index + 1 | number:0 }}</td>
          <td>prime number</td>
          <td>{{ prime | number:0 }}</td>
          <td>is prime? true</td>
        </tr>
      </tbody>
    </table>
  </div>

  <script>
    (function primesApp() {

      angular.module('Primes', ['infinite-scroll'])
        .factory('PrimeWorker', function ($q) {
          var worker = new Worker('./primes.js');
          var defer;

          worker.onmessage = function(e) {
            defer.resolve(e.data);
          };

          return {
            computePrimes: function (first, last) {
              defer = $q.defer();
              worker.postMessage({
                first: first,
                last: last
              });
              return defer.promise;
            }
          }
        })
        .controller('primesController', function ($scope, $filter, $timeout, $q, PrimeWorker) {
          var number = $filter('number');
          $scope.primes = [];
          var batchSize = 100;

          function computePrimes(first, last) {
            return PrimeWorker.computePrimes(first, last).then(function (numbers) {
              var k, n = numbers.length;
              for(k = 0; k < n; k += 1) {
                $scope.primes.push(numbers[k]);
              }
            });
          }

          $scope.find = function () {
            $scope.computing = true;

            return computePrimes($scope.primes.length, $scope.primes.length + batchSize)
            .then(function () {
              console.log('computed', $scope.primes.length, 'primes');
              $scope.computing = false;
            });
          };
        });
    }());
  </script>
</body>
</html>
