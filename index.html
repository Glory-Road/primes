<!DOCTYPE html>
<html lang="en" ng-app="Primes">

<head>
  <title>Primes</title>
  <script src="bower_components/angular/angular.js"></script>
  <script src="bower_components/angular-bindonce/bindonce.js"></script>
  <style>
    table {
      table-layout: fixed;
      border-collapse: collapse;
    }
    tbody {
      table-layout: fixed;
    }
    td {
      width: 100px;
      height: 20px;
    }
  </style>
</head>

<body>
  <h1>Primes</h1>

  <div ng-controller="primesController" ng-cloak>
    <button id="find" ng-click="find()">Find</button> <input ng-model="n" /> primes.
    <p>AngularJs application found first {{ primes.length }} prime numbers.</p>
    <table width="500">
      <colgroup>
        <col width="100">
        <col width="100">
        <col width="100">
        <col width="100">
        <col width="100">
      </colgroup>
      <tbody></tbody>
    </table>
  </div>

  <script>
    (function primesApp() {

      function isPrime(n) {
        var k;
        var limit = Math.sqrt(n);
        for (k = 2; k <= limit; k += 1) {
          if (n % k === 0) {
            return false;
          }
        }
        return true;
      }
      console.assert(isPrime(1));
      console.assert(isPrime(2));
      console.assert(isPrime(3));
      console.assert(!isPrime(4));
      console.assert(isPrime(5));
      console.assert(!isPrime(6));
      console.assert(isPrime(7));
      console.assert(isPrime(37));
      console.assert(!isPrime(38));

      // finds Nth prime
      var foundPrimes = [];
      function findPrime(n) {
        var k;
        if (foundPrimes.length) {
          k = foundPrimes[foundPrimes.length - 1] + 1;
        } else {
          k = 1;
        }
        while (foundPrimes.length < n) {
          if (isPrime(k)) {
            foundPrimes.push(k);
          }
          k += 1;
        };
        return foundPrimes[n - 1];
      }
      console.assert(findPrime(1) === 1);
      console.assert(findPrime(2) === 2);
      console.assert(findPrime(3) === 3);
      console.assert(findPrime(4) === 5);
      console.assert(findPrime(5) === 7);

      angular.module('Primes', ['pasvaz.bindonce'])
        .filter('isPrime', function () {
          return isPrime;
        })
        .controller('primesController', function ($scope, $filter, $timeout) {
          var number = $filter('number');
          $scope.n = 100000;

          function generateTableRows(first, last) {
            var k;
            var str = '';
            var line;
            for(k = first; k < last; k += 1) {
              line = '<tr><td>index</td> \
                <td>' + (k + 1) + '</td> \
                <td>prime number</td> \
                <td>' + $scope.primes[k] + '</td> \
                <td>is prime? true</td></tr>';
              str += line;
            }
            document.getElementsByTagName('tbody')[0].innerHTML += str;
            console.timeStamp('updated tbody ' + first + ' to ' + last);
          }

          $scope.find = function () {
            console.log('computing first', $scope.n, 'primes');

            foundPrimes = [];
            $scope.primes = [];

            var firstBatchN = 100;
            var k;
            for (k = 0; k < firstBatchN; k += 1) {
              var prime = findPrime(k + 2);
              $scope.primes.push(prime);
            }
            generateTableRows(0, firstBatchN);

            // return promise to allow timing this action
            return $timeout(function computeSecondBatch() {
              for (k = firstBatchN; k < $scope.n; k += 1) {
                var prime = findPrime(k + 2);
                $scope.primes.push(prime);
              }
              generateTableRows(firstBatchN, $scope.n);
            }, 0);

          };
        });
    }());
  </script>
</body>
</html>
